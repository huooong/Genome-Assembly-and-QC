#!/bin/bash

#Input and output directory (CORRECT THIS IF NEEDED)
INPUT_DIR="Data"
OUTPUT_DIR="Results"
FILTERED_DIR="$OUTPUT_DIR/Filtered"
ASSEMBLY_DIR="$OUTPUT_DIR/Assembly"

# Polishing using Racon
echo "STEP 5: Polishing assemblies with Racon"

## Load conda commands
CONDA_BASE=$(dirname $(dirname $(which conda)))
source "$CONDA_BASE/etc/profile.d/conda.sh"

##Create directory for polished assemblies
POLISH_DIR="$OUTPUT_DIR/Polished"
mkdir -p "$POLISH_DIR"

for assembly_folder in "$ASSEMBLY_DIR"/*; do
    sample=$(basename "$assembly_folder")
    sample_polish="$POLISH_DIR/$sample"
    mkdir -p "$sample_polish"

    assembly="$assembly_folder/assembly.fasta"
    reads="$FILTERED_DIR/${sample}_filtered.fastq"

    echo "Polishing $sample ..."

    ##Map reads back to the assembly
    conda activate minimap2
    minimap2 -x map-ont -t "$THREADS" "$assembly" "$reads" > "$sample_polish/${sample}_aln.sam"
    conda deactivate
    

    ##Sort and index alignment
    conda activate samtools_env
    samtools sort "$sample_polish/${sample}_aln.sam" -o "$sample_polish/${sample}_aln_sorted.bam"
    samtools index "$sample_polish/${sample}_aln_sorted.bam"
    conda deactivate
    

    ##Polish with Racon
    conda activate racon_env
    racon -t "$THREADS" "$reads" "$sample_polish/${sample}_aln.sam" "$assembly" > "$sample_polish/${sample}_racon.fasta"
    conda deactivate
    
    echo "$sample polished assembly saved at $sample_polish/${sample}_racon.fasta"
done
