###################################
#!/bin/bash

# Directories
INPUT_DIR="Data"
OUTPUT_DIR="Results"
FILTERED_DIR="$OUTPUT_DIR/Filtered"
ASSEMBLY_DIR="$OUTPUT_DIR/Assembly"

# Load conda commands
CONDA_BASE=$(dirname $(dirname $(which conda)))
source "$CONDA_BASE/etc/profile.d/conda.sh"

###################################

# Polishing using Racon
echo "---------------------------------------------------"
echo "Polishing assemblies with Racon"
echo "---------------------------------------------------"

## Racon parameters
THREADS=8
RACON_ROUNDS=3 #change if needed

## Directory for Racon-polished assemblies
RACON_DIR="$OUTPUT_DIR/Racon"
mkdir -p "$RACON_DIR"

## Run Racon
for assembly in "$ASSEMBLY_DIR"/*; do
    sample=$(basename "$assembly")
    sample_dir="$RACON_DIR/$sample"
    mkdir -p "$sample_dir"

    echo "Starting polishing with Racon for $sample ....."

    original_assembly="$assembly/assembly.fasta"
    reads="$FILTERED_DIR/$sample/${sample}_filtered.fastq"

    if [[ ! -f "$original_assembly" ]]; then
        echo "Error: Assembly not found for $sample"
        continue
    fi
    if [[ ! -f "$reads" ]]; then
        echo "Error: Filtered reads not found for $sample"
        continue
    fi

    current_assembly="$original_assembly"
    
    ## Run Racon rounds
    for round in $(seq 1 $RACON_ROUNDS); do
        echo "Racon round $round ....."
        
        ## Map reads with minimap2
        conda activate minimap2
        minimap2 -a -x map-ont -t "$THREADS" "$current_assembly" "$reads" \
            > "$sample_dir/r${round}.sam"
        conda deactivate
    
        ## Polish with Racon
        conda activate racon_env
        racon -t "$THREADS" "$reads" "$sample_dir/r${round}.sam" "$current_assembly" \
            > "$sample_dir/racon_round_${round}.fasta"
        conda deactivate

        current_assembly="$sample_polish/racon_round_${round}.fasta"
    done

    echo
    echo "Completed $RACON_ROUNDS rounds for Racon for $sample. Results have been saved in "$RACON_DIR"
    echo "---------------------------------------------------"
done

