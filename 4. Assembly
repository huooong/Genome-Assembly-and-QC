###################################
#!/bin/bash

# Input and output directory
INPUT_DIR="Data"
OUTPUT_DIR="Results"
FILTERED_DIR="$OUTPUT_DIR/Filtered"

# Load conda commands
CONDA_BASE=$(dirname $(dirname $(which conda)))
source "$CONDA_BASE/etc/profile.d/conda.sh"

###################################

# Assembling of sequencing data
echo "STEP 4: Assembling sequenced data using Flye Assembler"

## Load Flye environment
conda activate flye_env

## Create directory for assembly
ASSEMBLY_DIR="$OUTPUT_DIR/Assembly"
mkdir -p "$ASSEMBLY_DIR"

## Flye parameters
GENOME_SIZE="5m"
THREADS=4

## Run flye
for file in "$FILTERED_DIR"/*_filtered.fastq; do
	sample=$(basename "$file" _filtered.fastq)
	echo "Assembling $sample..."

	flye \
		--nano-raw "$file" \
		--genome-size "$GENOME_SIZE" \
		--out-dir "$ASSEMBLY_DIR/$sample" \
		--threads "$THREADS"
done
conda deactivate

echo "Assemblies saved in $ASSEMBLY_DIR"
