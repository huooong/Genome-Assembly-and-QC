###################################
#!/bin/bash

# Directories 
INPUT_DIR="Data"
OUTPUT_DIR="Results"
ASSEMBLY_DIR="$OUTPUT_DIR/Assembly"
RACON_DIR="$OUTPUT_DIR/Racon"
MEDAKA_DIR="$OUTPUT_DIR/Medaka"

# Load conda commands
CONDA_BASE=$(dirname $(dirname $(which conda)))
source "$CONDA_BASE/etc/profile.d/conda.sh"

###################################

# Run QUAST on output
echo "---------------------------------------------------"
echo "STEP 6: Assessing assembly quality with QUAST"
echo "---------------------------------------------------"

## Load QUAST environment
conda activate quast_env

## Directory for QUAST
QUAST_DIR="$OUTPUT_DIR/QUAST"
mkdir -p "$QUAST_DIR"

## QUAST parameters
THREADS=4
RACON_ROUNDS=3

## Run QUAST
for assembly in "$ASSEMBLY_DIR"/*; do
    [ -d "$assembly" ] || continue
    sample=$(basename "$assembly")

    raw_assembly="$ASSEMBLY_DIR/$sample/assembly.fasta"
    racon_polished="$RACON_DIR/$sample/racon_round_${RACON_ROUNDS}.fasta"
    medaka_polished="$MEDAKA_DIR/$sample/medaka.fasta" #CHANGE THIS

    echo "Running QUAST for $sample ....."
    
    if [[ -f "$medaka_polished" ]]; then
        quast.py \
            "$raw_assembly" "$racon_polished" "$medaka_polished" \
            -o "$QUAST_DIR/${sample}" \
            -l "${sample}_raw,${sample}_racon,${sample}_medaka" \
            --threads "$THREADS"
    else
        echo "Medaka polished file NOT found for $sample â€“ running QUAST without medaka"
        quast.py \
            "$raw_assembly" "$racon_polished" \
            -o "$QUAST_DIR/${sample}" \
            -l "${sample}_raw,${sample}_racon" \
            --threads "$THREADS"
    fi
    
    echo "QUAST report saved in: $QUAST_DIR"
    echo "---------------------------------------------------"
done
conda deactivate


