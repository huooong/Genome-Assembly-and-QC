#!/bin/bash
set -euo pipefail

#####################################
# User settings
#####################################

ASSEMBLY_DIR="Results/Assembly"        # Folder with all *.fasta assemblies
OUTPUT_DIR="Results/GTDBtk"            # Parent output folder
GTDB_DB="/databases/GTDB/gtdb_data/release226/226.0"
THREADS=8

#####################################
# Load conda + activate env
#####################################

CONDA_BASE=$(dirname "$(dirname "$(which conda)")")
source "$CONDA_BASE/etc/profile.d/conda.sh"

conda activate gtdbtk

#####################################
# Setup
#####################################

mkdir -p "$OUTPUT_DIR"

echo "Starting per-sample GTDB-Tk classification..."
echo "Assemblies: $ASSEMBLY_DIR"
echo "Output:     $OUTPUT_DIR"
echo "Database:   $GTDB_DB"
echo "Threads:    $THREADS"
echo

#####################################
# Sanity checks
#####################################

# Check database
if [ ! -d "$GTDB_DB" ]; then
    echo "[ERROR] GTDB database not found at: $GTDB_DB"
    exit 1
fi

# Check FASTA files
shopt -s nullglob
FASTA_FILES=("$ASSEMBLY_DIR"/*.fasta)

if [ ${#FASTA_FILES[@]} -eq 0 ]; then
    echo "[ERROR] No .fasta files found in $ASSEMBLY_DIR"
    exit 1
fi

#####################################
# Process each sample individually
#####################################

for FILE in "${FASTA_FILES[@]}"; do
    SAMPLE=$(basename "$FILE" .fasta)
    SAMPLE_OUT="$OUTPUT_DIR/$SAMPLE"

    echo "-----------------------------------------------"
    echo "Running GTDB-Tk for sample: $SAMPLE"
    echo "Input genome: $FILE"
    echo "Output dir:   $SAMPLE_OUT"
    echo "-----------------------------------------------"

    mkdir -p "$SAMPLE_OUT"

    gtdbtk classify \
        --genome_file "$FILE" \
        --out_dir "$SAMPLE_OUT" \
        --data_path "$GTDB_DB" \
        --cpus "$THREADS"

    echo "Finished sample: $SAMPLE"
    echo
done

echo "==============================================="
echo " All GTDB-Tk classifications completed!"
echo " Results stored in: $OUTPUT_DIR/SAMPLENAME/"
echo "==============================================="

