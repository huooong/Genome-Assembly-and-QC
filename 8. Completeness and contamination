###################################
#!/bin/bash

# Directories
INPUT_DIR="Data"
OUTPUT_DIR="Results"
ASSEMBLY_DIR="$OUTPUT_DIR/Assembly"
RACON_DIR="$OUTPUT_DIR/Racon"
MEDAKA_DIR="$OUTPUT_DIR/Medaka"

# Load conda commands
CONDA_BASE=$(dirname $(dirname $(which conda)))
source "$CONDA_BASE/etc/profile.d/conda.sh"

###################################

# Run CheckM2
echo "---------------------------------------------------"
echo "Assessing completeness and contamination with CheckM2"
echo "---------------------------------------------------"

## Load CheckM2 environment
conda activate checkm2_env

## Directory for CheckM2 
CHECKM2_DIR="$OUTPUT_DIR/CheckM2"
mkdir -p "$CHECKM2_DIR"

## CheckM2 database path
CHECKM2_DB="Database/CheckM2_database/uniref100.KO.1.dmnd"
export CHECKM2DB="$CHECKM2_DB"

## CheckM2 parameters
THREADS=16      #change
ASSEMBLIES="$ASSEMBLY_DIR" #change if needed
echo "Running CheckM2 on polished assemblies in $ASSEMBLIES"

## Run CheckM2
for fasta_file in "$ASSEMBLIES"/*/*.fasta;  do
    sample=$(basename "$(dirname "$fasta_file")")
    sample_dir="$CHECKM2_DIR/$sample"
    mkdir -p "$sample_dir"

    echo "Running CheckM2 on sample: $sample"
    checkm2 predict \
        --threads $THREADS \
        --input "$fasta_file" \
        --output_directory "$sample_dir" \
        --database_path "$CHECKM2_DB"

    echo "Results saved in $sample_dir"
    echo "----------------------------"
done

conda deactivate

