###################################
#!/bin/bash

# Directories 
INPUT_DIR="Data"
OUTPUT_DIR="Results"
MEDAKA_DIR="$OUTPUT_DIR/Medaka"

# Load conda commands
CONDA_BASE=$(dirname $(dirname $(which conda)))
source "$CONDA_BASE/etc/profile.d/conda.sh"

###################################

# Run QUAST on Medaka-polished output
echo "---------------------------------------------------"
echo "STEP: Assessing Medaka polished assemblies with QUAST"

## Load QUAST environment
conda activate quast_env

## Create output directory for QUAST
QUAST_DIR="$OUTPUT_DIR/QUAST_Medaka"
mkdir -p "$QUAST_DIR"

## QUAST parameters
THREADS=4

for sample_path in "$MEDAKA_DIR"/*; do
    [ -d "$sample_path" ] || continue
    sample=$(basename "$sample_path")

    medaka_assembly="$MEDAKA_DIR/$sample/consensus.fasta"

    # Check if file exists
    if [ ! -f "$medaka_assembly" ]; then
        echo "WARNING: Medaka output not found for $sample â€“ skipping"
        continue
    fi

    echo "Running QUAST for Medaka-polished sample: $sample"
    quast.py \
        "$medaka_assembly" \
        -o "$QUAST_DIR/${sample}" \
        -l "${sample}_medaka" \
        --threads "$THREADS"

    echo "Finished QUAST for $sample"
    echo "---------------------------------------------------"
done

conda deactivate

echo "All QUAST Medaka reports saved in: $QUAST_DIR"
echo "---------------------------------------------------"
