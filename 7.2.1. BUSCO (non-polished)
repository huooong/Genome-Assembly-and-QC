#######################################
#!/bin/bash

# Directories 
INPUT_DIR="Data"
OUTPUT_DIR="Results"
ASSEMBLY_DIR="$OUTPUT_DIR/Assembly"

# Load conda commands
CONDA_BASE=$(dirname $(dirname $(which conda)))
source "$CONDA_BASE/etc/profile.d/conda.sh"

#######################################

# Assessment of completeness and quality of assembly with BUSCO
echo "---------------------------------------------------"
echo "Assessing completeness and quality of assembly with BUSCO"
echo "---------------------------------------------------"

## Directory for BUSCO
BUSCO_DIR="Results/BUSCO_nonpolished"
mkdir -p "$BUSCO_DIR"

## Activate BUSCO environment
conda activate busco_env

## BUSCO parameters
CPU=16        #change

## Run BUSCO 
for assembly in "$ASSEMBLY_DIR"/*/*.fasta; do
    # Skip if no files found
    [ -e "$assembly" ] || continue

    filename=$(basename "$assembly")
    sample="${filename%%.*}"
    sample_dir="$BUSCO_DIR/$sample"
    mkdir -p "$sample_dir"

    echo "Running BUSCO on $sample"

    busco \
        -i "$assembly" \
        --auto-lineage-prok \
        -m genome \
        -c "$CPU" \
        --out_path "$sample_dir" 

    echo "Finished $sample" 
    echo "---------------------------------------------------"

done
conda deactivate



